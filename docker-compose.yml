services:
  kafka:
    image: apache/kafka:4.1.1
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

  order-service:
    image: event-sourcing-saga-multiservice-order-service:1.1.0
    build: 
      context: ./order-service
      dockerfile: Dockerfile
    ports:
      - "8001:8080"
    depends_on:
      kafka:
        condition: service_started
      order_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  payment-service:
    image: event-sourcing-saga-multiservice-payment-service:1.1.0
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    ports:
      - "8002:8080"
    depends_on:
      kafka:
        condition: service_started
      payment_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  inventory-service:
    image: event-sourcing-saga-multiservice-inventory-service:1.1.0
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    ports:
      - "8003:8080"
    depends_on:
      kafka:
        condition: service_started
      inventory_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  order_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: order_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - order_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  payment_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: payment_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - payment_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  inventory_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: inventory_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - inventory_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  user-service:
    image: event-sourcing-saga-multiservice-user-service:1.1.0
    build:
      context: ./user-service
      dockerfile: Dockerfile
    ports:
      - "8004:8080"
    depends_on:
      kafka:
        condition: service_started
      user_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  item-service:
    image: event-sourcing-saga-multiservice-item-service:1.1.0
    build:
      context: ./item-service
      dockerfile: Dockerfile
    ports:
      - "8005:8080"
    depends_on:
      kafka:
        condition: service_started
      item_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  cart-service:
    image: event-sourcing-saga-multiservice-cart-service:1.1.0
    build:
      context: ./cart-service
      dockerfile: Dockerfile
    ports:
      - "8006:8080"
    depends_on:
      kafka:
        condition: service_started
      cart_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  checkout-service:
    image: event-sourcing-saga-multiservice-checkout-service:1.1.0
    build:
      context: ./checkout-service
      dockerfile: Dockerfile
    ports:
      - "8007:8080"
    depends_on:
      kafka:
        condition: service_started
      checkout_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  return-service:
    image: event-sourcing-saga-multiservice-return-service:1.1.0
    build:
      context: ./return-service
      dockerfile: Dockerfile
    ports:
      - "8008:8080"
    depends_on:
      kafka:
        condition: service_started
      return_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  logistics-service:
    image: event-sourcing-saga-multiservice-logistics-service:1.1.0
    build:
      context: ./logistics-service
      dockerfile: Dockerfile
    ports:
      - "8009:8080"
    depends_on:
      kafka:
        condition: service_started
      logistics_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://logistics_postgres:5432/logistics_service
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres

  notification-service:
    image: event-sourcing-saga-multiservice-notification-service:1.1.0
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    ports:
      - "8010:8080"
    depends_on:
      kafka:
        condition: service_started
      notification_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://notification_postgres:5432/notification_service
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres

  user_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: user_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - user_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  item_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: item_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5436:5432"
    volumes:
      - item_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  cart_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: cart_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5437:5432"
    volumes:
      - cart_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  checkout_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: checkout_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5438:5432"
    volumes:
      - checkout_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  return_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: return_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5439:5432"
    volumes:
      - return_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  logistics_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: logistics_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5440:5432"
    volumes:
      - logistics_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: notification_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5441:5432"
    volumes:
      - notification_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  admin-service:
    image: event-sourcing-saga-multiservice-admin-service:1.0.0
    build:
      context: ./admin-service
      dockerfile: Dockerfile
    ports:
      - "8011:8011"
    depends_on:
      kafka:
        condition: service_started
      admin_postgres:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://admin_postgres:5432/admin_db
      SPRING_DATASOURCE_USERNAME: admin
      SPRING_DATASOURCE_PASSWORD: admin123
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SERVICE_URLS_ORDER: http://order-service:8080
      SERVICE_URLS_PAYMENT: http://payment-service:8080
      SERVICE_URLS_INVENTORY: http://inventory-service:8080
      SERVICE_URLS_USER: http://user-service:8080
      SERVICE_URLS_ITEM: http://item-service:8080
      SERVICE_URLS_CART: http://cart-service:8080
      SERVICE_URLS_CHECKOUT: http://checkout-service:8080
      SERVICE_URLS_RETURN: http://return-service:8080
      SERVICE_URLS_LOGISTICS: http://logistics-service:8080
      SERVICE_URLS_NOTIFICATION: http://notification-service:8080

  admin_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: admin_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    ports:
      - "5442:5432"
    volumes:
      - admin_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 10s
      timeout: 5s
      retries: 5

  ui-storefront:
    image: event-sourcing-saga-multiservice-ui-storefront:1.1.0
    build:
      context: ./ui-storefront
      dockerfile: Dockerfile
    ports:
      - "4201:4201"
    depends_on:
      - item-service
      - cart-service
      - inventory-service
    environment:
      PORT: 4201
      ITEM_SERVICE_URL: http://item-service:8080
      CART_SERVICE_URL: http://cart-service:8080
      INVENTORY_SERVICE_URL: http://inventory-service:8084

  ui-admin:
    image: event-sourcing-saga-multiservice-ui-admin:1.1.0
    build:
      context: ./ui-admin
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - user-service
      - item-service
      - order-service
      - payment-service
      - inventory-service
      - cart-service
      - checkout-service
      - return-service
      - logistics-service
      - notification-service
    environment:
      PORT: 3000
      ADMIN_SERVICE_URL: http://admin-service:8011
      USER_SERVICE_URL: http://user-service:8080
      ITEM_SERVICE_URL: http://item-service:8082
      ORDER_SERVICE_URL: http://order-service:8081
      PAYMENT_SERVICE_URL: http://payment-service:8083
      INVENTORY_SERVICE_URL: http://inventory-service:8084
      CART_SERVICE_URL: http://cart-service:8080
      CHECKOUT_SERVICE_URL: http://checkout-service:8086
      RETURN_SERVICE_URL: http://return-service:8087
      LOGISTICS_SERVICE_URL: http://logistics-service:8088
      NOTIFICATION_SERVICE_URL: http://notification-service:8089
      JWT_SECRET: adminSecretKeyForJWTTokenGenerationAndValidation2025WithExtraLengthToMeetHS512Requirements

  ui-checkout:
    image: event-sourcing-saga-multiservice-ui-checkout:1.1.0
    build:
      context: ./ui-checkout
      dockerfile: Dockerfile
    ports:
      - "4202:4202"
    depends_on:
      - checkout-service
      - payment-service
      - order-service
    environment:
      PORT: 4202
      CHECKOUT_SERVICE_URL: http://checkout-service:8086
      PAYMENT_SERVICE_URL: http://payment-service:8083
      ORDER_SERVICE_URL: http://order-service:8081

  ui-account:
    image: event-sourcing-saga-multiservice-ui-account:1.1.0
    build:
      context: ./ui-account
      dockerfile: Dockerfile
    ports:
      - "4203:4203"
    depends_on:
      - user-service
      - order-service
      - return-service
      - ui-auth
    environment:
      PORT: 4203
      USER_SERVICE_URL: http://user-service:8080
      ORDER_SERVICE_URL: http://order-service:8081
      RETURN_SERVICE_URL: http://return-service:8087
      AUTH_SERVICE_URL: http://ui-auth:4200
      JWT_SECRET: userAccountSecretKeyForJWTTokenGenerationAndValidation2025WithExtraLengthToMeetHS512Requirements

  ui-auth:
    image: event-sourcing-saga-multiservice-ui-auth:1.1.0
    build:
      context: ./ui-auth
      dockerfile: Dockerfile
    ports:
      - "4200:4200"
    depends_on:
      - user-service
    environment:
      PORT: 4200
      USER_SERVICE_URL: http://user-service:8080
      JWT_SECRET: centralizedAuthSecretKeyForJWTTokenGenerationAndValidation2025WithExtraLengthToMeetHS512Requirements
      UI_ADMIN_URL: http://localhost:3000
      UI_ACCOUNT_URL: http://localhost:4203
      UI_CHECKOUT_URL: http://localhost:4202
      UI_STOREFRONT_URL: http://localhost:4201

volumes:
  order_postgres_data:
    driver: local
  payment_postgres_data:
    driver: local
  inventory_postgres_data:
    driver: local
  user_postgres_data:
    driver: local
  item_postgres_data:
    driver: local
  cart_postgres_data:
    driver: local
  checkout_postgres_data:
    driver: local
  return_postgres_data:
    driver: local
  logistics_postgres_data:
    driver: local
  notification_postgres_data:
    driver: local
  admin_postgres_data:
    driver: local
