services:
  kafka:
    image: apache/kafka:4.1.1
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER

  order-service:
    image: event-sourcing-saga-multiservice-order-service:1.1.0
    build: 
      context: ./order-service
      dockerfile: Dockerfile
    ports:
      - "8001:8080"
    depends_on:
      kafka:
        condition: service_started
      order_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  payment-service:
    image: event-sourcing-saga-multiservice-payment-service:1.1.0
    build:
      context: ./payment-service
      dockerfile: Dockerfile
    ports:
      - "8002:8080"
    depends_on:
      kafka:
        condition: service_started
      payment_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  inventory-service:
    image: event-sourcing-saga-multiservice-inventory-service:1.1.0
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    ports:
      - "8003:8080"
    depends_on:
      kafka:
        condition: service_started
      inventory_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  order_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: order_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - order_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  payment_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: payment_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    volumes:
      - payment_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  inventory_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: inventory_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    volumes:
      - inventory_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  user-service:
    image: event-sourcing-saga-multiservice-user-service:1.1.0
    build:
      context: ./user-service
      dockerfile: Dockerfile
    ports:
      - "8004:8080"
    depends_on:
      kafka:
        condition: service_started
      user_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  item-service:
    image: event-sourcing-saga-multiservice-item-service:1.1.0
    build:
      context: ./item-service
      dockerfile: Dockerfile
    ports:
      - "8005:8080"
    depends_on:
      kafka:
        condition: service_started
      item_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  cart-service:
    image: event-sourcing-saga-multiservice-cart-service:1.1.0
    build:
      context: ./cart-service
      dockerfile: Dockerfile
    ports:
      - "8006:8080"
    depends_on:
      kafka:
        condition: service_started
      cart_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  checkout-service:
    image: event-sourcing-saga-multiservice-checkout-service:1.1.0
    build:
      context: ./checkout-service
      dockerfile: Dockerfile
    ports:
      - "8007:8080"
    depends_on:
      kafka:
        condition: service_started
      checkout_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  return-service:
    image: event-sourcing-saga-multiservice-return-service:1.1.0
    build:
      context: ./return-service
      dockerfile: Dockerfile
    ports:
      - "8008:8080"
    depends_on:
      kafka:
        condition: service_started
      return_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092

  logistics-service:
    image: event-sourcing-saga-multiservice-logistics-service:1.1.0
    build:
      context: ./logistics-service
      dockerfile: Dockerfile
    ports:
      - "8009:8080"
    depends_on:
      kafka:
        condition: service_started
      logistics_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://logistics_postgres:5432/logistics_service
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres

  notification-service:
    image: event-sourcing-saga-multiservice-notification-service:1.1.0
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    ports:
      - "8010:8080"
    depends_on:
      kafka:
        condition: service_started
      notification_postgres:
        condition: service_healthy
    environment:
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SPRING_DATASOURCE_URL: jdbc:postgresql://notification_postgres:5432/notification_service
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres

  user_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: user_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - user_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  item_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: item_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5436:5432"
    volumes:
      - item_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  cart_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: cart_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5437:5432"
    volumes:
      - cart_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  checkout_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: checkout_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5438:5432"
    volumes:
      - checkout_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  return_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: return_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5439:5432"
    volumes:
      - return_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  logistics_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: logistics_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5440:5432"
    volumes:
      - logistics_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  notification_postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: notification_service
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5441:5432"
    volumes:
      - notification_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  order_postgres_data:
    driver: local
  payment_postgres_data:
    driver: local
  inventory_postgres_data:
    driver: local
  user_postgres_data:
    driver: local
  item_postgres_data:
    driver: local
  cart_postgres_data:
    driver: local
  checkout_postgres_data:
    driver: local
  return_postgres_data:
    driver: local
  logistics_postgres_data:
    driver: local
  notification_postgres_data:
    driver: local
